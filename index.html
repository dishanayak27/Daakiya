<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Daakiya ‚Äî Deliver the Feels</title>
<meta name="description" content="Play as a daakiya on a tiny Indian planet. Deliver mail, meet people, feel things.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&family=Tiro+Devanagari+Hindi:ital@0;1&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --saffron: #FF6B2B;
    --turmeric: #F5A623;
    --peacock: #0077B6;
    --clay: #C1440E;
    --cream: #FFF8F0;
    --deep-night: #0D0A1E;
    --grass: #3D8B37;
    --gold: #E8B84B;
    --pink: #FF4A7A;
    --teal: #00C4B4;
    --font-display: 'Baloo 2', cursive;
    --font-body: 'Space Mono', monospace;
    --font-hindi: 'Tiro Devanagari Hindi', serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    width: 100%; height: 100%;
    overflow: hidden;
    background: var(--deep-night);
    font-family: var(--font-display);
    touch-action: none;
    user-select: none;
    -webkit-user-select: none;
  }

  #game-canvas {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    display: block;
  }

  /* ===== LOADING SCREEN ===== */
  #loading-screen {
    position: fixed; inset: 0; z-index: 1000;
    background: var(--deep-night);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 24px;
    transition: opacity 0.8s ease;
  }
  #loading-screen.fade-out { opacity: 0; pointer-events: none; }

  .loading-logo {
    font-family: var(--font-display);
    font-size: clamp(48px, 10vw, 96px);
    font-weight: 800;
    color: var(--saffron);
    letter-spacing: -2px;
    line-height: 1;
    text-shadow: 4px 4px 0 var(--clay), 8px 8px 0 rgba(255,107,43,0.2);
    animation: logoFloat 2s ease-in-out infinite;
  }
  .loading-tagline {
    font-family: var(--font-hindi);
    font-size: clamp(14px, 3vw, 20px);
    color: var(--turmeric);
    letter-spacing: 2px;
    opacity: 0.9;
  }
  .loading-bar-wrap {
    width: clamp(200px, 40vw, 360px);
    height: 6px;
    background: rgba(255,255,255,0.1);
    border-radius: 3px;
    overflow: hidden;
  }
  .loading-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--saffron), var(--turmeric));
    border-radius: 3px;
    width: 0%;
    transition: width 0.3s ease;
    box-shadow: 0 0 12px var(--saffron);
  }
  .loading-status {
    font-family: var(--font-body);
    font-size: 11px;
    color: rgba(255,255,255,0.4);
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .loading-envelope {
    font-size: 48px;
    animation: envelopeBounce 0.8s ease-in-out infinite alternate;
  }

  @keyframes logoFloat {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
  }
  @keyframes envelopeBounce {
    0% { transform: translateY(0) rotate(-5deg); }
    100% { transform: translateY(-12px) rotate(5deg); }
  }

  /* ===== START SCREEN ===== */
  #start-screen {
    position: fixed; inset: 0; z-index: 900;
    background: radial-gradient(ellipse at 50% 80%, rgba(255,107,43,0.15) 0%, var(--deep-night) 70%);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 32px;
    opacity: 0; pointer-events: none;
    transition: opacity 0.6s ease;
  }
  #start-screen.visible { opacity: 1; pointer-events: all; }

  .start-title-block { text-align: center; }
  .start-hindi {
    font-family: var(--font-hindi);
    font-size: clamp(12px, 2.5vw, 18px);
    color: var(--turmeric);
    letter-spacing: 4px;
    margin-bottom: 8px;
    display: block;
  }
  .start-main-title {
    font-family: var(--font-display);
    font-size: clamp(64px, 14vw, 128px);
    font-weight: 800;
    color: var(--saffron);
    letter-spacing: -4px;
    line-height: 0.9;
    text-shadow: 5px 5px 0 var(--clay);
    display: block;
  }
  .start-subtitle {
    font-family: var(--font-body);
    font-size: clamp(10px, 2vw, 14px);
    color: rgba(255,255,255,0.5);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-top: 12px;
    display: block;
  }

  .name-input-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  .name-label {
    font-family: var(--font-body);
    font-size: 11px;
    color: rgba(255,255,255,0.4);
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  .name-input {
    background: rgba(255,255,255,0.07);
    border: 2px solid rgba(255,107,43,0.4);
    border-radius: 12px;
    padding: 12px 20px;
    font-family: var(--font-display);
    font-size: 18px;
    font-weight: 600;
    color: white;
    text-align: center;
    width: 240px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .name-input:focus {
    border-color: var(--saffron);
    box-shadow: 0 0 20px rgba(255,107,43,0.3);
  }
  .name-input::placeholder { color: rgba(255,255,255,0.2); }

  .start-btn {
    background: var(--saffron);
    color: white;
    border: none;
    border-radius: 16px;
    padding: 18px 48px;
    font-family: var(--font-display);
    font-size: clamp(18px, 3vw, 24px);
    font-weight: 800;
    cursor: pointer;
    letter-spacing: 1px;
    box-shadow: 0 6px 0 var(--clay), 0 12px 32px rgba(255,107,43,0.4);
    transition: transform 0.1s, box-shadow 0.1s;
    position: relative;
  }
  .start-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 0 var(--clay), 0 16px 40px rgba(255,107,43,0.5); }
  .start-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 var(--clay), 0 4px 12px rgba(255,107,43,0.3); }

  .start-controls {
    font-family: var(--font-body);
    font-size: 10px;
    color: rgba(255,255,255,0.25);
    letter-spacing: 2px;
    text-align: center;
    line-height: 2;
  }

  /* ===== CUSTOMIZER PANEL ===== */
  #customizer-panel {
    position: fixed;
    bottom: 20px; right: 20px;
    z-index: 200;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
  }
  #customizer-panel.visible { opacity: 1; pointer-events: all; }

  .custom-toggle {
    width: 52px; height: 52px;
    background: rgba(13,10,30,0.85);
    border: 2px solid rgba(255,107,43,0.4);
    border-radius: 16px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
    cursor: pointer;
    backdrop-filter: blur(12px);
    margin-left: auto;
    transition: border-color 0.2s;
  }
  .custom-toggle:hover { border-color: var(--saffron); }

  .custom-drawer {
    background: rgba(13,10,30,0.92);
    border: 1px solid rgba(255,107,43,0.2);
    border-radius: 20px;
    padding: 16px;
    width: 200px;
    margin-top: 8px;
    backdrop-filter: blur(16px);
    display: none;
  }
  .custom-drawer.open { display: block; }
  .custom-section-title {
    font-family: var(--font-body);
    font-size: 9px;
    color: rgba(255,255,255,0.3);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 8px;
    margin-top: 12px;
  }
  .custom-section-title:first-child { margin-top: 0; }
  .color-swatches {
    display: flex; gap: 8px; flex-wrap: wrap;
  }
  .color-swatch {
    width: 28px; height: 28px;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.15s, border-color 0.15s;
  }
  .color-swatch:hover { transform: scale(1.15); }
  .color-swatch.active { border-color: white; transform: scale(1.1); }

  /* ===== EMOTE PICKER ===== */
  #emote-picker {
    position: fixed;
    bottom: 20px; left: 50%;
    transform: translateX(-50%);
    z-index: 200;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }
  #emote-picker.visible { opacity: 1; pointer-events: all; }

  .emote-btn {
    width: 48px; height: 48px;
    background: rgba(13,10,30,0.85);
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 14px;
    font-size: 22px;
    cursor: pointer;
    backdrop-filter: blur(12px);
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.15s, border-color 0.15s, background 0.15s;
    position: relative;
  }
  .emote-btn:hover {
    transform: translateY(-6px) scale(1.1);
    border-color: var(--turmeric);
    background: rgba(245,166,35,0.2);
  }
  .emote-btn:active { transform: translateY(-2px) scale(0.95); }
  .emote-btn .emote-label {
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%; transform: translateX(-50%);
    font-family: var(--font-body);
    font-size: 8px;
    color: white;
    background: rgba(0,0,0,0.7);
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s;
  }
  .emote-btn:hover .emote-label { opacity: 1; }

  /* ===== DELIVERY HUD ===== */
  #delivery-hud {
    position: fixed;
    top: 20px; left: 20px;
    z-index: 200;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
    max-width: 280px;
  }
  #delivery-hud.visible { opacity: 1; pointer-events: all; }

  .hud-card {
    background: rgba(13,10,30,0.88);
    border: 1px solid rgba(255,107,43,0.25);
    border-radius: 20px;
    padding: 16px 18px;
    backdrop-filter: blur(16px);
  }
  .hud-title {
    font-family: var(--font-body);
    font-size: 9px;
    color: var(--turmeric);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 10px;
  }
  .delivery-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    transition: opacity 0.3s;
  }
  .delivery-item:last-child { border-bottom: none; padding-bottom: 0; }
  .delivery-item.completed { opacity: 0.35; }
  .delivery-icon { font-size: 20px; flex-shrink: 0; }
  .delivery-info { flex: 1; min-width: 0; }
  .delivery-name {
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 700;
    color: white;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .delivery-desc {
    font-family: var(--font-body);
    font-size: 9px;
    color: rgba(255,255,255,0.35);
    margin-top: 1px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .delivery-check {
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.15);
    display: flex; align-items: center; justify-content: center;
    font-size: 11px;
    flex-shrink: 0;
    transition: background 0.3s, border-color 0.3s;
  }
  .delivery-item.completed .delivery-check {
    background: var(--grass);
    border-color: var(--grass);
  }

  /* ===== DIALOGUE BOX ===== */
  #dialogue-box {
    position: fixed;
    bottom: 90px; left: 50%;
    transform: translateX(-50%);
    z-index: 300;
    width: clamp(280px, 60vw, 560px);
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
    transform: translateX(-50%) translateY(20px);
  }
  #dialogue-box.visible {
    opacity: 1; pointer-events: all;
    transform: translateX(-50%) translateY(0);
  }
  .dialogue-card {
    background: rgba(13,10,30,0.95);
    border: 2px solid rgba(255,107,43,0.3);
    border-radius: 24px;
    padding: 20px 24px;
    backdrop-filter: blur(20px);
    box-shadow: 0 24px 60px rgba(0,0,0,0.6);
  }
  .dialogue-speaker {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 10px;
  }
  .dialogue-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    border: 2px solid var(--saffron);
    font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    background: rgba(255,107,43,0.2);
    flex-shrink: 0;
  }
  .dialogue-speaker-name {
    font-family: var(--font-display);
    font-size: 14px; font-weight: 700;
    color: var(--turmeric);
  }
  .dialogue-text {
    font-family: var(--font-display);
    font-size: clamp(14px, 2.5vw, 17px);
    font-weight: 500;
    color: rgba(255,255,255,0.9);
    line-height: 1.6;
    min-height: 48px;
  }
  .dialogue-hindi {
    font-family: var(--font-hindi);
    font-size: 12px;
    color: rgba(255,166,35,0.6);
    margin-top: 4px;
    font-style: italic;
  }
  .dialogue-continue {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 6px;
    margin-top: 12px;
    font-family: var(--font-body);
    font-size: 10px;
    color: rgba(255,255,255,0.3);
    cursor: pointer;
    transition: color 0.2s;
  }
  .dialogue-continue:hover { color: var(--turmeric); }
  .dialogue-continue .tap-hint { animation: blinkPulse 1.2s ease-in-out infinite; }
  @keyframes blinkPulse { 0%,100%{opacity:0.3} 50%{opacity:1} }

  /* ===== NOTIFICATION TOAST ===== */
  #toast-container {
    position: fixed;
    top: 20px; right: 20px;
    z-index: 500;
    display: flex; flex-direction: column; gap: 8px;
    pointer-events: none;
    max-width: 280px;
  }
  .toast {
    background: rgba(13,10,30,0.95);
    border-left: 3px solid var(--saffron);
    border-radius: 12px;
    padding: 12px 16px;
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 600;
    color: white;
    backdrop-filter: blur(12px);
    animation: toastIn 0.4s ease forwards, toastOut 0.4s ease 3s forwards;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  .toast.success { border-left-color: var(--grass); }
  .toast.info { border-left-color: var(--peacock); }
  @keyframes toastIn { from { opacity:0; transform: translateX(40px); } to { opacity:1; transform: translateX(0); } }
  @keyframes toastOut { from { opacity:1; } to { opacity:0; transform: translateX(40px); } }

  /* ===== PLAYER COUNTER ===== */
  #player-count {
    position: fixed;
    top: 20px; right: 20px;
    z-index: 200;
    opacity: 0;
    transition: opacity 0.3s;
    display: flex; align-items: center; gap: 8px;
    background: rgba(13,10,30,0.8);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 8px 14px;
    backdrop-filter: blur(12px);
    font-family: var(--font-body);
    font-size: 11px;
    color: rgba(255,255,255,0.5);
  }
  #player-count.visible { opacity: 1; }
  .player-dot {
    width: 8px; height: 8px;
    background: var(--grass);
    border-radius: 50%;
    box-shadow: 0 0 8px var(--grass);
    animation: dotPulse 2s ease-in-out infinite;
  }
  @keyframes dotPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* ===== COMPLETION SCREEN ===== */
  #completion-screen {
    position: fixed; inset: 0; z-index: 800;
    background: rgba(13,10,30,0.96);
    display: none; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 24px;
    text-align: center;
    padding: 40px;
  }
  #completion-screen.visible { display: flex; }

  .completion-emoji { font-size: 72px; animation: completionBounce 0.6s ease 0.2s both; }
  @keyframes completionBounce { from{transform:scale(0) rotate(-20deg)} 70%{transform:scale(1.2) rotate(5deg)} to{transform:scale(1) rotate(0)} }

  .completion-title {
    font-family: var(--font-display);
    font-size: clamp(32px, 8vw, 64px);
    font-weight: 800;
    color: var(--saffron);
    text-shadow: 4px 4px 0 var(--clay);
    animation: completionBounce 0.6s ease 0.4s both;
  }
  .completion-sub {
    font-family: var(--font-hindi);
    font-size: clamp(14px, 3vw, 22px);
    color: var(--turmeric);
    animation: completionBounce 0.6s ease 0.6s both;
    max-width: 500px;
    line-height: 1.5;
  }
  .completion-stats {
    display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;
    animation: completionBounce 0.6s ease 0.8s both;
  }
  .stat-pill {
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px; padding: 12px 20px;
  }
  .stat-number {
    font-family: var(--font-display);
    font-size: 28px; font-weight: 800;
    color: white;
    display: block;
  }
  .stat-label {
    font-family: var(--font-body);
    font-size: 10px; color: rgba(255,255,255,0.4);
    letter-spacing: 1px; text-transform: uppercase;
  }
  .play-again-btn {
    background: var(--saffron);
    color: white; border: none;
    border-radius: 14px;
    padding: 14px 36px;
    font-family: var(--font-display);
    font-size: 18px; font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 0 var(--clay);
    transition: transform 0.1s, box-shadow 0.1s;
    animation: completionBounce 0.6s ease 1s both;
  }
  .play-again-btn:hover { transform: translateY(-2px); }

  /* ===== MOBILE CONTROLS ===== */
  #mobile-controls {
    position: fixed; bottom: 0; left: 0; right: 0;
    z-index: 200;
    display: none;
    pointer-events: none;
    padding: 20px;
  }
  #mobile-controls.visible { display: flex; justify-content: space-between; align-items: flex-end; }

  .joystick-zone {
    width: 120px; height: 120px;
    position: relative;
    pointer-events: all;
  }
  .joystick-base {
    width: 120px; height: 120px;
    border-radius: 50%;
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,255,255,0.12);
    position: absolute;
    top: 0; left: 0;
  }
  .joystick-thumb {
    width: 48px; height: 48px;
    border-radius: 50%;
    background: rgba(255,107,43,0.8);
    border: 2px solid rgba(255,255,255,0.3);
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    transition: transform 0.05s;
    box-shadow: 0 4px 12px rgba(255,107,43,0.4);
  }

  .action-buttons {
    display: flex; flex-direction: column; gap: 10px; align-items: flex-end;
    pointer-events: all;
  }
  .action-btn {
    width: 60px; height: 60px;
    border-radius: 18px;
    border: none; cursor: pointer;
    font-size: 22px;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(8px);
    transition: transform 0.1s, box-shadow 0.1s;
  }
  .action-btn:active { transform: scale(0.88); }
  .jump-btn { background: rgba(0,119,182,0.85); box-shadow: 0 4px 0 rgba(0,60,100,0.8); }
  .interact-btn { background: rgba(255,107,43,0.85); box-shadow: 0 4px 0 rgba(193,68,14,0.8); }

  /* ===== CROSSHAIR / INTERACT INDICATOR ===== */
  #interact-hint {
    position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%);
    z-index: 200;
    background: rgba(13,10,30,0.85);
    border: 1px solid rgba(255,107,43,0.4);
    border-radius: 20px; padding: 8px 18px;
    font-family: var(--font-body); font-size: 11px;
    color: rgba(255,255,255,0.7);
    letter-spacing: 1px;
    display: none;
    backdrop-filter: blur(8px);
    animation: hintFloat 1.5s ease-in-out infinite;
  }
  #interact-hint.visible { display: block; }
  @keyframes hintFloat { 0%,100%{transform:translateX(-50%) translateY(0)} 50%{transform:translateX(-50%) translateY(-4px)} }

  /* ===== EMOTE POPUP ===== */
  .emote-popup {
    position: absolute;
    font-size: 28px;
    pointer-events: none;
    z-index: 150;
    animation: emoteFloat 2.5s ease forwards;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,0.5));
  }
  @keyframes emoteFloat {
    0% { opacity:0; transform: translateY(0) scale(0.5); }
    15% { opacity:1; transform: translateY(-10px) scale(1.2); }
    70% { opacity:1; transform: translateY(-40px) scale(1); }
    100% { opacity:0; transform: translateY(-60px) scale(0.8); }
  }

  /* ===== MINIMAP ===== */
  #minimap {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    z-index: 200;
    opacity: 0; transition: opacity 0.3s;
  }
  #minimap.visible { opacity: 1; }
  #minimap-canvas {
    width: 80px; height: 80px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.15);
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    backdrop-filter: blur(4px);
  }
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading-screen">
  <div class="loading-envelope">‚úâÔ∏è</div>
  <div class="loading-logo">DAAKIYA</div>
  <div class="loading-tagline">‡§°‡§æ‡§ï‡§ø‡§Ø‡§æ ‚Äî ‡§è‡§ï ‡§õ‡•ã‡§ü‡•Ä ‡§¶‡•Å‡§®‡§ø‡§Ø‡§æ ‡§ï‡•á ‡§¨‡§°‡§º‡•á ‡§ï‡§ø‡§∏‡•ç‡§∏‡•á</div>
  <div class="loading-bar-wrap">
    <div class="loading-bar" id="loading-bar"></div>
  </div>
  <div class="loading-status" id="loading-status">Ironing the uniform...</div>
</div>

<!-- START SCREEN -->
<div id="start-screen">
  <div class="start-title-block">
    <span class="start-hindi">‡§è‡§ï ‡§õ‡•ã‡§ü‡•Ä ‡§¶‡•Å‡§®‡§ø‡§Ø‡§æ ‡§ï‡•á ‡§¨‡§°‡§º‡•á ‡§ï‡§ø‡§∏‡•ç‡§∏‡•á</span>
    <span class="start-main-title">DAAKIYA</span>
    <span class="start-subtitle">Deliver Mail ¬∑ Meet People ¬∑ Feel Things</span>
  </div>
  <div class="name-input-block">
    <div class="name-label">Your Name</div>
    <input type="text" class="name-input" id="player-name-input" placeholder="Raju, Priya, Bhola..." maxlength="16" autocomplete="off">
  </div>
  <button class="start-btn" id="start-btn">‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•ã üìÆ</button>
  <div class="start-controls">
    WASD / Arrow Keys ‚Äî Move &nbsp;¬∑&nbsp; Space ‚Äî Jump &nbsp;¬∑&nbsp; E ‚Äî Interact<br>
    Works on mobile too!
  </div>
</div>

<!-- GAME CANVAS -->
<canvas id="game-canvas"></canvas>

<!-- PLAYER COUNT -->
<div id="player-count">
  <div class="player-dot"></div>
  <span id="player-count-num">1</span> daakiya online
</div>

<!-- DELIVERY HUD -->
<div id="delivery-hud">
  <div class="hud-card">
    <div class="hud-title">üìÆ Aaj Ki Chitthiyaan</div>
    <div id="delivery-list"></div>
  </div>
</div>

<!-- MINIMAP -->
<div id="minimap">
  <canvas id="minimap-canvas" width="80" height="80"></canvas>
</div>

<!-- DIALOGUE BOX -->
<div id="dialogue-box">
  <div class="dialogue-card">
    <div class="dialogue-speaker">
      <div class="dialogue-avatar" id="dialogue-avatar">üë§</div>
      <div class="dialogue-speaker-name" id="dialogue-speaker-name">...</div>
    </div>
    <div class="dialogue-text" id="dialogue-text"></div>
    <div class="dialogue-hindi" id="dialogue-hindi"></div>
    <div class="dialogue-continue" id="dialogue-continue">
      <span>tap to continue</span>
      <span class="tap-hint">‚ñ∂</span>
    </div>
  </div>
</div>

<!-- INTERACT HINT -->
<div id="interact-hint">Press E to interact</div>

<!-- EMOTE PICKER -->
<div id="emote-picker">
  <!-- Populated by JS -->
</div>

<!-- CUSTOMIZER PANEL -->
<div id="customizer-panel">
  <div class="custom-toggle" id="custom-toggle">üëï</div>
  <div class="custom-drawer" id="custom-drawer">
    <div class="custom-section-title">Kurta Color</div>
    <div class="color-swatches" id="kurta-swatches"></div>
    <div class="custom-section-title">Pant Color</div>
    <div class="color-swatches" id="pant-swatches"></div>
    <div class="custom-section-title">Skin Tone</div>
    <div class="color-swatches" id="skin-swatches"></div>
  </div>
</div>

<!-- MOBILE CONTROLS -->
<div id="mobile-controls">
  <div class="joystick-zone" id="joystick-zone">
    <div class="joystick-base"></div>
    <div class="joystick-thumb" id="joystick-thumb"></div>
  </div>
  <div class="action-buttons">
    <button class="action-btn interact-btn" id="mobile-interact">üìÆ</button>
    <button class="action-btn jump-btn" id="mobile-jump">‚¨ÜÔ∏è</button>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- COMPLETION SCREEN -->
<div id="completion-screen">
  <div class="completion-emoji">üìÆ</div>
  <div class="completion-title">Bahut Khoob!</div>
  <div class="completion-sub">Aapne aaj ki saari chitthiyaan pahuncha di.<br>Har khat mein ek dil ki baat thi...</div>
  <div class="completion-stats">
    <div class="stat-pill">
      <span class="stat-number" id="stat-deliveries">5</span>
      <span class="stat-label">Deliveries</span>
    </div>
    <div class="stat-pill">
      <span class="stat-number" id="stat-time">--</span>
      <span class="stat-label">Minutes</span>
    </div>
    <div class="stat-pill">
      <span class="stat-number" id="stat-emotes">0</span>
      <span class="stat-label">Emotes Used</span>
    </div>
  </div>
  <button class="play-again-btn" id="play-again-btn">Phir Se Khelein üîÑ</button>
</div>

<!-- THREE.JS + CANNON.JS + TWEEN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>

<script>
// ============================================================
// DAAKIYA ‚Äî Indian Messenger Game
// Full production game with Three.js + Cannon.js + PartyKit
// ============================================================

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PLANET_RADIUS = 28;
const PLANET_GRAVITY = -18;
const PLAYER_SPEED = 14;
const PLAYER_JUMP = 10;
const RUN_MULTIPLIER = 1.7;
const INTERACT_DISTANCE = 5.5;
const PARTYKIT_HOST = 'daakiya.your-name.partykit.dev'; // replace with your PartyKit host

// ‚îÄ‚îÄ COLORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COLORS = {
  saffron: 0xFF6B2B, turmeric: 0xF5A623, peacock: 0x0077B6,
  clay: 0xC1440E, cream: 0xFFF8F0, grass: 0x4CAF50,
  sky1: 0x1a0a3e, sky2: 0x2d1b69, gold: 0xE8B84B,
  road: 0xD4956A, wall: 0xE8C49A, roof: 0xC1440E,
  sand: 0xF2D5A0, bark: 0x8B6239, leaf: 0x2E7D32,
  water: 0x4FC3F7, night: 0x0D0A1E,
};

// ‚îÄ‚îÄ EMOTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const EMOTES = [
  { icon: 'üôè', label: 'Namaste' },
  { icon: 'ü§å', label: 'Kya Baat!' },
  { icon: 'üíÉ', label: 'Nachna' },
  { icon: '‚òï', label: 'Chai?' },
  { icon: 'üò§', label: 'Arre Yaar' },
  { icon: '‚ù§Ô∏è', label: 'Dil' },
  { icon: 'üå∫', label: 'Phool' },
  { icon: 'üéâ', label: 'Dhamaka' },
  { icon: 'üëã', label: 'Aao' },
  { icon: 'üòÇ', label: 'Haha' },
];

// ‚îÄ‚îÄ CUSTOMIZER OPTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const KURTA_COLORS = ['#FF6B2B','#0077B6','#2E7D32','#9C27B0','#F5A623','#E91E63','#FFFFFF','#FF4444'];
const PANT_COLORS  = ['#FFFFFF','#F5F5DC','#1A237E','#263238','#4E342E','#1B5E20','#BF360C','#212121'];
const SKIN_TONES   = ['#FDBCB4','#F1C27D','#E0AC69','#C68642','#8D5524','#5D3317'];

// ‚îÄ‚îÄ DELIVERY QUESTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DELIVERIES = [
  {
    id: 'kisan',
    name: 'Shambhu Kisan',
    icon: 'üåæ',
    desc: 'Khet ke paas, peepal ke neeche',
    giver: { name: 'Post Office', avatar: 'üìÆ', pos: null },
    receiver: { name: 'Shambhu Kisan', avatar: 'üë®‚Äçüåæ' },
    item: 'Sarpanch ko patri',
    color: 0x4CAF50,
    dialogs: [
      // pickup
      [
        { speaker: 'Post Office', avatar: 'üìÆ', text: "Ek zaruri chitthi hai, bhai. Shambhu ne apne sarpanch ko bahut gusse mein likha hai.", hindi: "Paani ki problem hai gaon mein..." },
        { speaker: 'Post Office', avatar: 'üìÆ', text: "Deliver kar do jaldi. Aur haan ‚Äî yeh zara sensative matter hai. Handle with care!" }
      ],
      // delivery
      [
        { speaker: 'Shambhu Kisan', avatar: 'üë®‚Äçüåæ', text: "Oh, daakiye! Aayi kya meri chitthi? Woh Sarpanch ko bheja tha..." },
        { speaker: 'Shambhu Kisan', avatar: 'üë®‚Äçüåæ', text: "Nahin nahin, yeh toh Sarpanch ko deni hai! Seedha unke ghar le jao. Keh do Shambhu ne bheja hai!", hindi: "\"Jawab chahiye mujhe!\"" }
      ]
    ],
    sarpancDlg: [
      { speaker: 'Sarpanch Mohan', avatar: 'üßì', text: "Kya hai yeh... Shambhu ka khatt? Hehehe!" },
      { speaker: 'Sarpanch Mohan', avatar: 'üßì', text: "Arre wah! Itni takleef uthai likho, toh kuchh karna padega. Theek hai bhai, naali ka kaam next week se!", hindi: "\"Gusse mein bhi izzat hai\"" },
    ],
    complete: "Sarpanch ne hasate hue chitthi padhi. Shambhu ki takleef sun li gayi!"
  },
  {
    id: 'rishta',
    name: 'Pappu Sharma',
    icon: 'üíå',
    desc: 'Chai stall ke baaju mein, laal building',
    item: 'Rishta ka lifa-fa',
    color: 0xFF4A7A,
    receiver: { name: 'Pappu Sharma', avatar: 'üò∞' },
    dialogs: [
      [
        { speaker: 'Post Office', avatar: 'üìÆ', text: "Yeh ek rishta ka khat hai. Pappu Sharma ke naam pe. Unki ammi ne bheja hai." },
        { speaker: 'Post Office', avatar: 'üìÆ', text: "Seedha unhe do. Aur... dekhna, woh bhaag na jaayein! üòÖ", hindi: "\"Shaadi ka mamla hai\"" }
      ],
      [
        { speaker: 'Pappu Sharma', avatar: 'üò∞', text: "H-haan? Kya hai? Daakiya? Kya laaye ho..." },
        { speaker: 'Pappu Sharma', avatar: 'üò∞', text: "RISHTA?! Ammi ne... oh nahi. Oh nahi nahi nahi! Main taiyaar nahin hoon!!", hindi: "\"Abhi nahin, ammi!\"" },
        { speaker: 'Pappu Sharma', avatar: 'üò∞', text: "...Magar ek baar naam toh bataao. Sirf naam. Bas. Matlab information ke liye.", hindi: "\"Hehehe...\"" }
      ]
    ],
    complete: "Pappu ne envelope khusha ke pakad liya... phir carefully fold karke pocket mein rakh liya! üíå"
  },
  {
    id: 'dadi',
    name: 'Saroj Dadi',
    icon: 'üëµ',
    desc: 'Mandir ke paas, chhoti haveli',
    item: 'NRI pote ka khat',
    color: 0xE8B84B,
    receiver: { name: 'Saroj Dadi', avatar: 'üëµ' },
    dialogs: [
      [
        { speaker: 'Post Office', avatar: 'üìÆ', text: "Saroj Dadi ka naam hai. Unke pote Arjun ne videsh se likha hai." },
        { speaker: 'Post Office', avatar: 'üìÆ', text: "Ek saal se woh aa nahin paaye... yeh khat kaafi zaruri hai unke liye." }
      ],
      [
        { speaker: 'Saroj Dadi', avatar: 'üëµ', text: "Kaun ho beta? Daakiye? ...Khat laaye ho?" },
        { speaker: 'Saroj Dadi', avatar: 'üëµ', text: "Arjun ka? Mere Arjun ka?! ...(reads quietly)..." },
        { speaker: 'Saroj Dadi', avatar: 'üëµ', text: "Aa raha hai woh... Diwali pe aa raha hai ghar. Rabb ka shukar hai.", hindi: "\"Aankhein bhar aayi...\"" }
      ]
    ],
    complete: "Dadi ne khat seene se laga liya. Kuch khat sirf kagaz nahin hote... üåº"
  },
  {
    id: 'reportcard',
    name: 'Gudiya / Mrs. Verma',
    icon: 'üìù',
    desc: 'School ke paas, neeli chhat',
    item: 'Report Card',
    color: 0x9C27B0,
    receiver: { name: 'Gudiya (Student)', avatar: 'üßí' },
    isChoice: true,
    dialogs: [
      [
        { speaker: 'Post Office', avatar: 'üìÆ', text: "Yeh report card hai ‚Äî Gudiya Verma ka. Unke ghar bhejni hai." },
        { speaker: 'Post Office', avatar: 'üìÆ', text: "Haan, wahi Gudiya jo school se pehle aa jaati hai! Kuch toh chakkar hai... ü§î" }
      ],
      [
        { speaker: 'Gudiya', avatar: 'üßí', text: "Daakiye bhaiya!! Ruko ruko RUKO!!" },
        { speaker: 'Gudiya', avatar: 'üßí', text: "Woh report card... woh meri hai. Please mujhe do. PLEASE. Main sudhaar loongi marks.", hindi: "\"Ammi ko mat batana...\"" },
        { speaker: 'Gudiya', avatar: 'üßí', text: "Yaaa ammi ko do. Sahi baat hai. Wahi theek hai. üò≠" }
      ]
    ],
    choiceDialogs: {
      kid: [
        { speaker: 'Gudiya', avatar: 'üßí', text: "SHUKRIYAA BHAIYAAA!! Aap best ho!!" },
        { speaker: 'Gudiya', avatar: 'üßí', text: "...Aaj raat toh gaya. Kal bhi. Par aap best ho!", hindi: "\"Insan bano, robot nahi!\"" }
      ],
      mom: [
        { speaker: 'Mrs. Verma', avatar: 'üë©', text: "Haan? Kya hai? Report card? Laao beta..." },
        { speaker: 'Mrs. Verma', avatar: 'üë©', text: "...94%! Woh to bahut achha hai! Yeh Gudiya kahan hai, usse milai do!", hindi: "\"Proud moment!\"" },
      ]
    },
    complete: "Aapne faisla kiya... duniya ko chalate rehne mein madad ki!"
  },
  {
    id: 'nakli',
    name: 'Ramesh Shopkeeper',
    icon: 'üì¶',
    desc: 'Bazaar mein, peeli dukaan',
    item: 'Mystery Parcel',
    color: 0xFF5722,
    receiver: { name: 'Ramesh ji', avatar: 'üßî' },
    dialogs: [
      [
        { speaker: 'Post Office', avatar: 'üìÆ', text: "Yeh heavy parcel hai, Ramesh Lal ke naam pe. Bazaar ki peeli dukaan pe deliver karo." },
        { speaker: 'Post Office', avatar: 'üìÆ', text: "Kuchh toh strange lag raha hai... bhaar zyaada hai, address bhi thoda dhundla hai. Par rules to rules hain." }
      ],
      [
        { speaker: 'Ramesh ji', avatar: 'üßî', text: "Haan? Kya laaye ho daakiye?" },
        { speaker: 'Ramesh ji', avatar: 'üßî', text: "...Yeh kya? 'Premium Export Quality Branded Goods'?! Arrey, yeh toh sab NAKLI hai!" },
        { speaker: 'Ramesh ji', avatar: 'üßî', text: "Main yeh nahin lunga. Wapas bhejo! Mere grahak asli cheez ke laayak hain. WAPAS JAO!", hindi: "\"Izzat se zyaada koi business nahin\"" }
      ]
    ],
    complete: "Ramesh ji ne parcel wapas kar diya. Asli dukaan, asli izzat! üè™"
  }
];

// ‚îÄ‚îÄ RANDOM NAME GENERATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NAMES = ['Raju','Priya','Bhola','Sunita','Mohan','Kavita','Ajay','Neha','Suresh','Radha','Ankit','Pooja','Deepak','Geeta','Vikas'];
function randomName() { return NAMES[Math.floor(Math.random()*NAMES.length)]; }

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const State = {
  loading: true, inMenu: true, playing: false, paused: false,
  playerName: randomName(),
  playerColor: { kurta: KURTA_COLORS[0], pant: PANT_COLORS[0], skin: SKIN_TONES[2] },
  deliveries: DELIVERIES.map(d => ({ ...d, completed: false, active: false })),
  currentDelivery: null, currentDialogIndex: 0, inDialogue: false,
  nearNPC: null, npcMeshes: [],
  emoteCount: 0, startTime: 0,
  remotePlayersMap: {},
};

// ‚îÄ‚îÄ THREE.JS SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas = document.getElementById('game-canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, powerPreference: 'high-performance' });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.1;

const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x0D0A1E, 0.012);

const camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.1, 500);

// ‚îÄ‚îÄ CANNON.JS PHYSICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const world = new CANNON.World();
world.broadphase = new CANNON.SAPBroadphase(world);
world.allowSleep = true;

// ‚îÄ‚îÄ LIGHTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupLighting() {
  const ambient = new THREE.AmbientLight(0x332255, 0.8);
  scene.add(ambient);

  const sun = new THREE.DirectionalLight(0xFFD580, 2.2);
  sun.position.set(60, 80, 40);
  sun.castShadow = true;
  sun.shadow.mapSize.width = 2048;
  sun.shadow.mapSize.height = 2048;
  sun.shadow.camera.near = 0.5;
  sun.shadow.camera.far = 200;
  sun.shadow.camera.left = -60;
  sun.shadow.camera.right = 60;
  sun.shadow.camera.top = 60;
  sun.shadow.camera.bottom = -60;
  sun.shadow.bias = -0.001;
  scene.add(sun);

  const fill = new THREE.PointLight(0xFF6B2B, 0.6, 80);
  fill.position.set(-30, 20, -30);
  scene.add(fill);

  const rim = new THREE.DirectionalLight(0x4FC3F7, 0.4);
  rim.position.set(-40, -20, 60);
  scene.add(rim);
}

// ‚îÄ‚îÄ PROCEDURAL PLANET BUILDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const planetGroup = new THREE.Group();
scene.add(planetGroup);

function spherePos(lat, lon, r) {
  const phi = (90 - lat) * Math.PI / 180;
  const theta = (lon + 180) * Math.PI / 180;
  return new THREE.Vector3(
    -r * Math.sin(phi) * Math.cos(theta),
    r * Math.cos(phi),
    r * Math.sin(phi) * Math.sin(theta)
  );
}

function placeOnPlanet(obj, lat, lon, heightOffset = 0) {
  const pos = spherePos(lat, lon, PLANET_RADIUS + heightOffset);
  obj.position.copy(pos);
  obj.lookAt(new THREE.Vector3(0,0,0));
  obj.rotateX(Math.PI);
}

function buildPlanet() {
  // Core planet sphere
  const geo = new THREE.SphereGeometry(PLANET_RADIUS, 64, 64);
  const mat = new THREE.MeshLambertMaterial({ color: COLORS.sand });
  const mesh = new THREE.Mesh(geo, mat);
  mesh.receiveShadow = true;
  planetGroup.add(mesh);

  // Grass patches
  buildGrassPatches();
  // Roads / paths
  buildRoads();
  // Buildings
  buildBuildings();
  // Trees
  buildTrees();
  // Mandir
  buildMandir();
  // Chai stall
  buildChaiStall();
  // Water tank
  buildWaterTank();
  // Lamp posts
  buildLampPosts();
  // NPC spawn markers (invisible, used for interaction)
  placeNPCMarkers();
}

function buildGrassPatches() {
  const patchDefs = [
    [30, 20], [40, 100], [-20, 200], [10, 300], [-40, 60], [60, 160], [-60, -80]
  ];
  patchDefs.forEach(([lat, lon]) => {
    const geo = new THREE.SphereGeometry(6, 8, 8, 0, Math.PI*2, 0, Math.PI*0.15);
    const mat = new THREE.MeshLambertMaterial({ color: 0x4CAF50, side: THREE.FrontSide });
    const m = new THREE.Mesh(geo, mat);
    const pos = spherePos(lat, lon, PLANET_RADIUS - 0.5);
    m.position.copy(pos);
    m.lookAt(new THREE.Vector3(0,0,0));
    m.rotateX(Math.PI);
    scene.add(m);
  });
}

function buildRoads() {
  // Road ring around equator
  for (let lon = 0; lon < 360; lon += 12) {
    const geo = new THREE.BoxGeometry(3.5, 0.15, 4.2);
    const mat = new THREE.MeshLambertMaterial({ color: 0xBBA070 });
    const m = new THREE.Mesh(geo, mat);
    m.receiveShadow = true;
    placeOnPlanet(m, 0, lon, 0.05);
    planetGroup.add(m);
  }
}

function makeCuboid(w, h, d, color) {
  const geo = new THREE.BoxGeometry(w, h, d);
  const mat = new THREE.MeshLambertMaterial({ color });
  const m = new THREE.Mesh(geo, mat);
  m.castShadow = true; m.receiveShadow = true;
  return m;
}

function buildBuildings() {
  const buildings = [
    // [lat, lon, w, h, d, wallColor, roofColor, label]
    [10, 40, 5, 4, 4, 0xF5DEB3, 0xC1440E],
    [10, 80, 4, 5.5, 4, 0xFFE0B2, 0xBF360C],
    [-10, 60, 6, 3, 5, 0xFFF9C4, 0x9C27B0],
    [-10, 120, 4.5, 4, 4, 0xF8BBD9, 0xE91E63],
    [15, 180, 5, 4.5, 4, 0xDCEDC8, 0x2E7D32],
    [5, 220, 3.5, 6, 3.5, 0xB3E5FC, 0x0077B6],
    [-15, 300, 5, 4, 4, 0xFFCCBC, 0xFF5722],
    [20, -40, 4, 3.5, 4, 0xE1BEE7, 0x7B1FA2],
    [-20, -100, 5, 4, 5, 0xFFE082, 0xF57F17],
    [5, -160, 4, 5, 4, 0xCFD8DC, 0x37474F],
  ];

  buildings.forEach(([lat, lon, w, h, d, wc, rc]) => {
    const grp = new THREE.Group();
    // Wall
    const wall = makeCuboid(w, h, d, wc);
    wall.position.y = h/2;
    grp.add(wall);
    // Roof (slightly pyramidal / hip roof)
    const roofGeo = new THREE.ConeGeometry(Math.max(w,d)*0.78, 2.2, 4);
    const roofMat = new THREE.MeshLambertMaterial({ color: rc });
    const roof = new THREE.Mesh(roofGeo, roofMat);
    roof.position.y = h + 1.0;
    roof.rotation.y = Math.PI/4;
    roof.castShadow = true;
    grp.add(roof);
    // Window
    const win = makeCuboid(0.9, 0.9, 0.15, 0x4FC3F7);
    win.position.set(0, h*0.55, d/2+0.05);
    grp.add(win);
    // Door
    const door = makeCuboid(0.9, 1.4, 0.15, 0x8B6239);
    door.position.set(0.5, 0.7, d/2+0.05);
    grp.add(door);

    placeOnPlanet(grp, lat, lon, 0);
    planetGroup.add(grp);
  });
}

function buildTrees() {
  const treeDefs = [
    [25, 10], [25, 160], [-30, 80], [-30, 240], [45, 290],
    [-45, 130], [35, -60], [-35, -140], [0, -200], [50, 50],
    [-5, 340], [15, -280], [-25, -20], [40, 200], [-50, 310],
  ];
  treeDefs.forEach(([lat, lon]) => {
    const grp = new THREE.Group();
    const trunk = makeCuboid(0.6, 2.5, 0.6, COLORS.bark);
    trunk.position.y = 1.25;
    grp.add(trunk);
    // Layered foliage
    [0, 1.2, 2.2].forEach((y, i) => {
      const r = 2.0 - i * 0.4;
      const geo = new THREE.ConeGeometry(r, 2.0, 7);
      const mat = new THREE.MeshLambertMaterial({ color: i === 0 ? 0x2E7D32 : i === 1 ? 0x388E3C : 0x4CAF50 });
      const layer = new THREE.Mesh(geo, mat);
      layer.castShadow = true;
      layer.position.y = 2.2 + y;
      grp.add(layer);
    });
    placeOnPlanet(grp, lat, lon, 0);
    planetGroup.add(grp);
  });
}

function buildMandir() {
  const grp = new THREE.Group();
  // Base platform
  const base = makeCuboid(8, 0.6, 8, 0xF5F5DC);
  base.position.y = 0.3;
  grp.add(base);
  // Sanctum
  const main = makeCuboid(5, 5, 5, 0xFFF8E1);
  main.position.y = 3.1;
  grp.add(main);
  // Shikhara (tower)
  for (let i = 0; i < 5; i++) {
    const s = 2.5 - i * 0.3;
    const box = makeCuboid(s, 1.0, s, i%2===0 ? 0xFFF8E1 : 0xFFE082);
    box.position.y = 5.5 + i * 0.9;
    grp.add(box);
  }
  // Kalash (pot on top)
  const kalashGeo = new THREE.SphereGeometry(0.5, 8, 8);
  const kalashMat = new THREE.MeshLambertMaterial({ color: 0xFFD700 });
  const kalash = new THREE.Mesh(kalashGeo, kalashMat);
  kalash.position.y = 10.4;
  grp.add(kalash);
  // Flag
  const flagPoleGeo = new THREE.CylinderGeometry(0.06, 0.06, 2.5, 6);
  const flagPoleMat = new THREE.MeshLambertMaterial({ color: 0xFF8F00 });
  const flagPole = new THREE.Mesh(flagPoleGeo, flagPoleMat);
  flagPole.position.y = 11.7;
  grp.add(flagPole);
  // Pillars
  [[-2,2],[-2,-2],[2,2],[2,-2]].forEach(([x,z]) => {
    const pill = makeCuboid(0.7, 4, 0.7, 0xFFF3E0);
    pill.position.set(x, 2.6, z);
    grp.add(pill);
  });
  // Steps
  for (let s = 0; s < 3; s++) {
    const step = makeCuboid(6+s*1.2, 0.35, 6+s*1.2, 0xEFEBE9);
    step.position.y = 0.6 + s * 0.35;
    step.position.z = -0.3 * s;
    grp.add(step);
  }
  placeOnPlanet(grp, -25, 180, 0);
  planetGroup.add(grp);
}

function buildChaiStall() {
  const grp = new THREE.Group();
  // Counter
  const counter = makeCuboid(5, 2, 1.5, 0x8D6E63);
  counter.position.y = 1.0;
  grp.add(counter);
  // Canopy
  const canopyGeo = new THREE.BoxGeometry(6, 0.2, 3);
  const canopyMat = new THREE.MeshLambertMaterial({ color: 0xFF6B2B });
  const canopy = new THREE.Mesh(canopyGeo, canopyMat);
  canopy.position.y = 3.3;
  grp.add(canopy);
  // Posts
  [[-2.2,0.6],[2.2,0.6],[-2.2,-0.6],[2.2,-0.6]].forEach(([x,z]) => {
    const post = makeCuboid(0.18, 3.5, 0.18, 0x5D4037);
    post.position.set(x, 1.75, z);
    grp.add(post);
  });
  // Chai pot / kettle (big sphere)
  const potGeo = new THREE.SphereGeometry(0.6, 8, 8);
  const potMat = new THREE.MeshLambertMaterial({ color: 0xFF8F00 });
  const pot = new THREE.Mesh(potGeo, potMat);
  pot.position.set(-1.2, 2.3, 0);
  grp.add(pot);
  // Cups
  for (let i = 0; i < 3; i++) {
    const cupGeo = new THREE.CylinderGeometry(0.2, 0.15, 0.35, 8);
    const cupMat = new THREE.MeshLambertMaterial({ color: 0xFFF9C4 });
    const cup = new THREE.Mesh(cupGeo, cupMat);
    cup.position.set(0.5 + i*0.55, 2.2, 0);
    grp.add(cup);
  }
  // Sign
  const signGeo = new THREE.BoxGeometry(4, 0.8, 0.1);
  const signMat = new THREE.MeshLambertMaterial({ color: 0xF57F17 });
  const sign = new THREE.Mesh(signGeo, signMat);
  sign.position.set(0, 4.2, -0.65);
  grp.add(sign);
  placeOnPlanet(grp, 5, 270, 0);
  planetGroup.add(grp);
}

function buildWaterTank() {
  const grp = new THREE.Group();
  // Legs
  [[1.4,1.4],[1.4,-1.4],[-1.4,1.4],[-1.4,-1.4]].forEach(([x,z]) => {
    const leg = makeCuboid(0.3, 6, 0.3, 0x607D8B);
    leg.position.set(x, 3, z);
    grp.add(leg);
  });
  // Tank cylinder
  const tGeo = new THREE.CylinderGeometry(2.2, 2.2, 3, 12);
  const tMat = new THREE.MeshLambertMaterial({ color: 0x78909C });
  const tank = new THREE.Mesh(tGeo, tMat);
  tank.position.y = 7.5;
  tank.castShadow = true;
  grp.add(tank);
  // Dome top
  const dGeo = new THREE.SphereGeometry(2.2, 12, 8, 0, Math.PI*2, 0, Math.PI/2);
  const dMat = new THREE.MeshLambertMaterial({ color: 0x607D8B });
  const dome = new THREE.Mesh(dGeo, dMat);
  dome.position.y = 9.0;
  grp.add(dome);
  placeOnPlanet(grp, -5, 0, 0);
  planetGroup.add(grp);
}

function buildLampPosts() {
  const lampDefs = [
    [3, 30], [3, 90], [3, 150], [3, 210], [3, 270], [3, 330],
    [-3, 60], [-3, 120], [-3, 180], [-3, 240], [-3, 300], [-3, 0],
  ];
  lampDefs.forEach(([lat, lon]) => {
    const grp = new THREE.Group();
    const post = makeCuboid(0.18, 5, 0.18, 0x37474F);
    post.position.y = 2.5;
    grp.add(post);
    const arm = makeCuboid(1.5, 0.14, 0.14, 0x37474F);
    arm.position.set(0.65, 5.1, 0);
    grp.add(arm);
    const bulbGeo = new THREE.SphereGeometry(0.28, 8, 8);
    const bulbMat = new THREE.MeshLambertMaterial({ color: 0xFFFF99, emissive: 0xFFFF00, emissiveIntensity: 0.8 });
    const bulb = new THREE.Mesh(bulbGeo, bulbMat);
    bulb.position.set(1.3, 5.0, 0);
    grp.add(bulb);
    const light = new THREE.PointLight(0xFFD580, 0.8, 12);
    light.position.set(1.3, 5.0, 0);
    grp.add(light);
    placeOnPlanet(grp, lat, lon, 0);
    planetGroup.add(grp);
  });
}

function buildPostOffice() {
  const grp = new THREE.Group();
  // Main building
  const body = makeCuboid(7, 5, 6, 0xFFCDD2);
  body.position.y = 2.5;
  grp.add(body);
  // Iconic roof
  const roofGeo = new THREE.BoxGeometry(8, 0.5, 7);
  const roofMat = new THREE.MeshLambertMaterial({ color: 0xE53935 });
  const roof = new THREE.Mesh(roofGeo, roofMat);
  roof.position.y = 5.25;
  roof.castShadow = true;
  grp.add(roof);
  // Columns
  [[-2.5, 3], [2.5, 3]].forEach(([x, z]) => {
    const col = makeCuboid(0.55, 5, 0.55, 0xFFEBEE);
    col.position.set(x, 2.5, z);
    grp.add(col);
  });
  // Door
  const door = makeCuboid(1.5, 2.5, 0.2, 0x5D4037);
  door.position.set(0, 1.25, 3.05);
  grp.add(door);
  // "DAK GHAR" sign
  const signGeo = new THREE.BoxGeometry(4, 0.9, 0.15);
  const signMat = new THREE.MeshLambertMaterial({ color: 0xFFD700, emissive: 0xFFD700, emissiveIntensity: 0.3 });
  const sign = new THREE.Mesh(signGeo, signMat);
  sign.position.set(0, 4.0, 3.1);
  grp.add(sign);
  // Letterbox
  const box = makeCuboid(1.0, 1.8, 0.8, 0xE53935);
  box.position.set(-4.5, 0.9, 0);
  grp.add(box);
  placeOnPlanet(grp, 0, 0, 0);
  planetGroup.add(grp);
  return grp;
}

// ‚îÄ‚îÄ NPC MESHES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NPC_POSITIONS = [
  { id: 'kisan', lat: 30, lon: 90 },      // Farmer at field
  { id: 'rishta', lat: 5, lon: 265 },     // Pappu near chai stall
  { id: 'dadi', lat: -22, lon: 175 },     // Dadi near mandir
  { id: 'reportcard', lat: 15, lon: 150 },// Gudiya near school
  { id: 'nakli', lat: -5, lon: 310 },     // Ramesh shopkeeper
];

function makeNPC(color, hatColor) {
  const grp = new THREE.Group();
  // Body
  const body = makeCuboid(0.85, 1.2, 0.5, color);
  body.position.y = 0.9;
  grp.add(body);
  // Head
  const headGeo = new THREE.SphereGeometry(0.45, 10, 10);
  const headMat = new THREE.MeshLambertMaterial({ color: COLORS.clay });
  const head = new THREE.Mesh(headGeo, headMat);
  head.position.y = 1.95;
  head.castShadow = true;
  grp.add(head);
  // Hat
  const hatGeo = new THREE.CylinderGeometry(0.42, 0.42, 0.25, 8);
  const hatMat = new THREE.MeshLambertMaterial({ color: hatColor || 0x8B6239 });
  const hat = new THREE.Mesh(hatGeo, hatMat);
  hat.position.y = 2.38;
  grp.add(hat);
  // Arms
  [-0.6, 0.6].forEach(x => {
    const arm = makeCuboid(0.25, 1.0, 0.25, color);
    arm.position.set(x, 0.9, 0);
    grp.add(arm);
  });
  // Legs
  [-0.22, 0.22].forEach(x => {
    const leg = makeCuboid(0.28, 0.9, 0.28, 0x37474F);
    leg.position.set(x, 0.15, 0);
    grp.add(leg);
  });
  // Exclamation marker
  const excGrp = new THREE.Group();
  const excGeo = new THREE.CylinderGeometry(0.05, 0.05, 0.6, 6);
  const excMat = new THREE.MeshLambertMaterial({ color: 0xFFD700, emissive: 0xFFD700, emissiveIntensity: 0.5 });
  const excStick = new THREE.Mesh(excGeo, excMat);
  excStick.position.y = 0.35;
  excGrp.add(excStick);
  const excDotGeo = new THREE.SphereGeometry(0.1, 6, 6);
  const excDot = new THREE.Mesh(excDotGeo, excMat);
  excDot.position.y = 0.0;
  excGrp.add(excDot);
  excGrp.position.y = 2.6;
  excGrp.userData.isExclamation = true;
  grp.add(excGrp);
  return grp;
}

function placeNPCMarkers() {
  NPC_POSITIONS.forEach(({ id, lat, lon }) => {
    const delivery = State.deliveries.find(d => d.id === id);
    if (!delivery) return;
    const colors = [0xFF8F00, 0xE91E63, 0xF57F17, 0x7B1FA2, 0xFF5722];
    const idx = NPC_POSITIONS.findIndex(n => n.id === id);
    const npc = makeNPC(colors[idx], 0x5D4037);
    npc.userData.deliveryId = id;
    npc.userData.npcId = id;
    placeOnPlanet(npc, lat, lon, 0.5);
    planetGroup.add(npc);
    State.npcMeshes.push({ mesh: npc, id, lat, lon });
  });
}

// ‚îÄ‚îÄ PLAYER MESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildPlayerMesh(kurta, pant, skin) {
  const grp = new THREE.Group();
  const kurtaColor = new THREE.Color(kurta);
  const pantColor = new THREE.Color(pant);
  const skinColor = new THREE.Color(skin);

  // Torso (kurta)
  const torso = makeCuboid(0.9, 1.3, 0.55, kurtaColor.getHex());
  torso.position.y = 1.05;
  grp.add(torso);

  // Head
  const headGeo = new THREE.SphereGeometry(0.42, 12, 12);
  const headMat = new THREE.MeshLambertMaterial({ color: skinColor.getHex() });
  const head = new THREE.Mesh(headGeo, headMat);
  head.position.y = 2.0;
  head.castShadow = true;
  grp.add(head);

  // Daakiya cap (red-banded khaki)
  const capGeo = new THREE.CylinderGeometry(0.38, 0.46, 0.30, 8);
  const capMat = new THREE.MeshLambertMaterial({ color: 0xC8A96E });
  const cap = new THREE.Mesh(capGeo, capMat);
  cap.position.y = 2.36;
  grp.add(cap);
  const bandGeo = new THREE.CylinderGeometry(0.47, 0.47, 0.09, 8);
  const bandMat = new THREE.MeshLambertMaterial({ color: 0xE53935 });
  const band = new THREE.Mesh(bandGeo, bandMat);
  band.position.y = 2.26;
  grp.add(band);
  const brimGeo = new THREE.CylinderGeometry(0.58, 0.58, 0.06, 8);
  const brimMat = new THREE.MeshLambertMaterial({ color: 0xBFA05A });
  const brim = new THREE.Mesh(brimGeo, brimMat);
  brim.position.y = 2.19;
  grp.add(brim);

  // Arms
  const armL = makeCuboid(0.26, 1.1, 0.26, kurtaColor.getHex());
  armL.position.set(-0.62, 1.0, 0);
  armL.userData.isArmL = true;
  grp.add(armL);
  const armR = makeCuboid(0.26, 1.1, 0.26, kurtaColor.getHex());
  armR.position.set(0.62, 1.0, 0);
  armR.userData.isArmR = true;
  grp.add(armR);

  // Legs
  const legL = makeCuboid(0.28, 1.0, 0.28, pantColor.getHex());
  legL.position.set(-0.23, 0.2, 0);
  legL.userData.isLegL = true;
  grp.add(legL);
  const legR = makeCuboid(0.28, 1.0, 0.28, pantColor.getHex());
  legR.position.set(0.23, 0.2, 0);
  legR.userData.isLegR = true;
  grp.add(legR);

  // Mail bag
  const bag = makeCuboid(0.55, 0.55, 0.2, 0xE65100);
  bag.position.set(-0.65, 0.9, 0.28);
  grp.add(bag);
  const strap = makeCuboid(0.08, 1.0, 0.08, 0x8D6E63);
  strap.position.set(-0.35, 1.2, 0.1);
  strap.rotation.z = Math.PI * 0.15;
  grp.add(strap);

  return grp;
}

// ‚îÄ‚îÄ PHYSICS PLAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let playerMesh = null;
let playerBody = null;
let cameraAngle = 0; // horizontal orbit
let cameraPitch = 0.4; // vertical pitch
let cameraDistance = 12;
let isOnGround = false;
let canJump = true;
const velocity = new CANNON.Vec3();

function createPlayer() {
  playerMesh = buildPlayerMesh(
    State.playerColor.kurta,
    State.playerColor.pant,
    State.playerColor.skin
  );
  scene.add(playerMesh);

  // Start on top of planet
  playerMesh.position.set(0, PLANET_RADIUS + 2.5, 0);
  playerMesh.userData.onPlanet = true;
}

// ‚îÄ‚îÄ REMOTE PLAYERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const remotePlayers = {};

function addRemotePlayer(id, data) {
  if (remotePlayers[id]) return;
  const mesh = buildPlayerMesh(
    data.kurta || KURTA_COLORS[0],
    data.pant || PANT_COLORS[0],
    data.skin || SKIN_TONES[2]
  );
  // Nametag
  const tag = makeNameTag(data.name || 'Daakiya');
  mesh.add(tag);
  scene.add(mesh);
  mesh.position.set(0, PLANET_RADIUS + 2.5, 0);
  remotePlayers[id] = { mesh, lastPos: new THREE.Vector3(), data };
}

function removeRemotePlayer(id) {
  if (remotePlayers[id]) {
    scene.remove(remotePlayers[id].mesh);
    delete remotePlayers[id];
  }
}

function makeNameTag(name) {
  // Simple sprite-based label using canvas texture
  const canvas2 = document.createElement('canvas');
  canvas2.width = 256; canvas2.height = 64;
  const ctx = canvas2.getContext('2d');
  ctx.fillStyle = 'rgba(13,10,30,0.75)';
  roundRect(ctx, 4, 4, 248, 56, 12);
  ctx.fill();
  ctx.font = 'bold 28px "Baloo 2", sans-serif';
  ctx.fillStyle = '#FFF8F0';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(name.substring(0,12), 128, 32);
  const tex = new THREE.CanvasTexture(canvas2);
  const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, depthTest: false });
  const sprite = new THREE.Sprite(mat);
  sprite.position.y = 3.0;
  sprite.scale.set(2.4, 0.6, 1);
  return sprite;
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.lineTo(x+w-r, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+r);
  ctx.lineTo(x+w, y+h-r);
  ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
  ctx.lineTo(x+r, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-r);
  ctx.lineTo(x, y+r);
  ctx.quadraticCurveTo(x, y, x+r, y);
  ctx.closePath();
}

// ‚îÄ‚îÄ PARTYKIT MULTIPLAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let partySocket = null;
let myPlayerId = 'local_' + Math.random().toString(36).substr(2,9);

function connectMultiplayer() {
  // We'll connect to PartyKit ‚Äî replace PARTYKIT_HOST with your own or use wss fallback
  const wsUrl = `wss://${PARTYKIT_HOST}/party/daakiya-world`;
  try {
    partySocket = new WebSocket(wsUrl);
    partySocket.onopen = () => {
      showToast('üåê Connected to the village!', 'info');
      sendPlayerState();
      updatePlayerCountUI();
    };
    partySocket.onmessage = (evt) => {
      try {
        const msg = JSON.parse(evt.data);
        handleMultiplayerMessage(msg);
      } catch(e) {}
    };
    partySocket.onclose = () => {
      showToast('üìµ Disconnected from village', 'info');
      // cleanup remote players
      Object.keys(remotePlayers).forEach(removeRemotePlayer);
      updatePlayerCountUI();
    };
    partySocket.onerror = () => {
      // silently fall back to solo mode
    };
  } catch(e) {
    // offline / demo mode
  }
}

function sendPlayerState() {
  if (!partySocket || partySocket.readyState !== WebSocket.OPEN) return;
  if (!playerMesh) return;
  partySocket.send(JSON.stringify({
    type: 'update',
    id: myPlayerId,
    name: State.playerName,
    pos: { x: playerMesh.position.x, y: playerMesh.position.y, z: playerMesh.position.z },
    rot: { y: playerMesh.rotation.y },
    kurta: State.playerColor.kurta,
    pant: State.playerColor.pant,
    skin: State.playerColor.skin,
  }));
}

function handleMultiplayerMessage(msg) {
  if (msg.type === 'update' && msg.id !== myPlayerId) {
    if (!remotePlayers[msg.id]) addRemotePlayer(msg.id, msg);
    const rp = remotePlayers[msg.id];
    rp.mesh.position.set(msg.pos.x, msg.pos.y, msg.pos.z);
    rp.mesh.rotation.y = msg.rot.y;
    updatePlayerCountUI();
  }
  if (msg.type === 'leave') removeRemotePlayer(msg.id);
  if (msg.type === 'emote' && msg.id !== myPlayerId) {
    const rp = remotePlayers[msg.id];
    if (rp) showEmoteAboveMesh(rp.mesh, msg.emote);
  }
}

function broadcastEmote(emoteIcon) {
  if (!partySocket || partySocket.readyState !== WebSocket.OPEN) return;
  partySocket.send(JSON.stringify({ type: 'emote', id: myPlayerId, emote: emoteIcon }));
}

function updatePlayerCountUI() {
  const count = 1 + Object.keys(remotePlayers).length;
  document.getElementById('player-count-num').textContent = count;
}

// ‚îÄ‚îÄ STARS / SKYBOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildStars() {
  const geo = new THREE.BufferGeometry();
  const verts = [];
  for (let i = 0; i < 3000; i++) {
    const r = 300 + Math.random() * 200;
    const phi = Math.random() * Math.PI * 2;
    const theta = Math.random() * Math.PI;
    verts.push(
      r * Math.sin(theta) * Math.cos(phi),
      r * Math.cos(theta),
      r * Math.sin(theta) * Math.sin(phi)
    );
  }
  geo.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));
  const mat = new THREE.PointsMaterial({ color: 0xFFFFFF, size: 0.6, transparent: true, opacity: 0.85 });
  const stars = new THREE.Points(geo, mat);
  scene.add(stars);
}

// ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const keys = {};
document.addEventListener('keydown', e => {
  keys[e.code] = true;
  if (e.code === 'KeyE' && !State.inDialogue) tryInteract();
  if (e.code === 'Space') { e.preventDefault(); tryJump(); }
});
document.addEventListener('keyup', e => { keys[e.code] = false; });

// Mouse look
let mouseDown = false, lastMouseX = 0, lastMouseY = 0;
document.addEventListener('mousedown', e => { if (e.button === 2 || e.button === 0) { mouseDown = true; lastMouseX = e.clientX; lastMouseY = e.clientY; } });
document.addEventListener('mouseup', e => { mouseDown = false; });
document.addEventListener('mousemove', e => {
  if (!mouseDown || State.inDialogue) return;
  const dx = e.clientX - lastMouseX;
  const dy = e.clientY - lastMouseY;
  cameraAngle -= dx * 0.006;
  cameraPitch = Math.max(0.1, Math.min(1.2, cameraPitch + dy * 0.004));
  lastMouseX = e.clientX;
  lastMouseY = e.clientY;
});
document.addEventListener('contextmenu', e => e.preventDefault());

// Scroll zoom
document.addEventListener('wheel', e => {
  cameraDistance = Math.max(5, Math.min(22, cameraDistance + e.deltaY * 0.015));
});

// Touch look
let lastTouch = null;
document.addEventListener('touchstart', e => {
  if (e.touches.length === 1 && !isJoystickTouch(e.touches[0])) {
    lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  }
});
document.addEventListener('touchmove', e => {
  if (e.touches.length === 1 && lastTouch && !isJoystickTouch(e.touches[0])) {
    const dx = e.touches[0].clientX - lastTouch.x;
    const dy = e.touches[0].clientY - lastTouch.y;
    cameraAngle -= dx * 0.005;
    cameraPitch = Math.max(0.1, Math.min(1.2, cameraPitch + dy * 0.004));
    lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  }
  e.preventDefault();
}, { passive: false });
document.addEventListener('touchend', () => { lastTouch = null; });

// ‚îÄ‚îÄ JOYSTICK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const joystickState = { active: false, x: 0, y: 0 };
let joystickTouchId = null;
const joystickZone = document.getElementById('joystick-zone');
const joystickThumb = document.getElementById('joystick-thumb');

function isJoystickTouch(touch) {
  return joystickTouchId !== null && touch.identifier === joystickTouchId;
}

joystickZone.addEventListener('touchstart', e => {
  const t = e.changedTouches[0];
  joystickTouchId = t.identifier;
  joystickState.active = true;
  updateJoystick(t.clientX, t.clientY);
}, { passive: true });

document.addEventListener('touchmove', e => {
  for (const t of e.changedTouches) {
    if (t.identifier === joystickTouchId) {
      updateJoystick(t.clientX, t.clientY);
    }
  }
}, { passive: true });

document.addEventListener('touchend', e => {
  for (const t of e.changedTouches) {
    if (t.identifier === joystickTouchId) {
      joystickState.active = false;
      joystickState.x = 0; joystickState.y = 0;
      joystickTouchId = null;
      joystickThumb.style.transform = 'translate(-50%, -50%)';
    }
  }
});

function updateJoystick(cx, cy) {
  const rect = joystickZone.getBoundingClientRect();
  const cx0 = rect.left + rect.width / 2;
  const cy0 = rect.top + rect.height / 2;
  const dx = cx - cx0;
  const dy = cy - cy0;
  const dist = Math.sqrt(dx*dx + dy*dy);
  const maxDist = rect.width / 2 - 10;
  const ratio = Math.min(1, dist / maxDist);
  const angle = Math.atan2(dy, dx);
  joystickState.x = Math.cos(angle) * ratio;
  joystickState.y = Math.sin(angle) * ratio;
  const tx = Math.cos(angle) * ratio * maxDist;
  const ty = Math.sin(angle) * ratio * maxDist;
  joystickThumb.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px))`;
}

// Mobile buttons
document.getElementById('mobile-jump').addEventListener('touchstart', e => { e.preventDefault(); tryJump(); }, { passive: false });
document.getElementById('mobile-interact').addEventListener('touchstart', e => { e.preventDefault(); tryInteract(); }, { passive: false });

// ‚îÄ‚îÄ PLAYER MOVEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let playerYVel = 0; // velocity along planet radial axis
let animTime = 0;
let isRunning = false;

function getMoveInput() {
  let fx = 0, fz = 0;
  if (keys['KeyW'] || keys['ArrowUp']) fz = 1;
  if (keys['KeyS'] || keys['ArrowDown']) fz = -1;
  if (keys['KeyA'] || keys['ArrowLeft']) fx = -1;
  if (keys['KeyD'] || keys['ArrowRight']) fx = 1;
  if (joystickState.active) {
    fx = joystickState.x;
    fz = -joystickState.y;
  }
  return { fx, fz };
}

// Store player orientation quaternion separately for smooth rotation
let playerQuat = new THREE.Quaternion();
let playerFacing = new THREE.Vector3(0, 0, 1); // world-space facing direction on surface

function updatePlayer(dt) {
  if (!playerMesh || !State.playing) return;

  const { fx, fz } = getMoveInput();
  const moving = Math.abs(fx) > 0.05 || Math.abs(fz) > 0.05;
  const shift = keys['ShiftLeft'] || keys['ShiftRight'];
  const speed = (shift ? PLAYER_SPEED * RUN_MULTIPLIER : PLAYER_SPEED) * dt;
  isRunning = moving && shift;

  // Planet surface up vector at player position
  const planetUp = playerMesh.position.clone().normalize();

  // Build camera-relative axes tangent to planet surface
  // Camera orbits around planet; cameraAngle = horizontal, cameraPitch = vertical
  // World-space camera position offset direction:
  const camDirWorld = new THREE.Vector3(
    Math.sin(cameraAngle),
    0,
    Math.cos(cameraAngle)
  ).normalize();
  // Project camera forward onto planet tangent plane
  const camForwardTangent = camDirWorld.clone()
    .sub(planetUp.clone().multiplyScalar(camDirWorld.dot(planetUp)))
    .normalize();
  // If degenerate (looking straight up/down), use stored facing
  const camRight = new THREE.Vector3().crossVectors(planetUp, camForwardTangent).normalize();

  // Move direction from input (camera-relative, on surface)
  let moveDir = new THREE.Vector3();
  if (moving) {
    moveDir.addScaledVector(camForwardTangent, fz);
    moveDir.addScaledVector(camRight, fx);
    // Re-project to be strictly tangent
    moveDir.sub(planetUp.clone().multiplyScalar(moveDir.dot(planetUp)));
    if (moveDir.length() > 0.001) moveDir.normalize();
  }

  // Apply horizontal movement (stay on sphere surface)
  if (moving && moveDir.length() > 0.001) {
    playerMesh.position.addScaledVector(moveDir, speed);
    // Re-normalize to sphere radius (preserve vertical offset)
    const currentR2 = playerMesh.position.length();
    playerMesh.position.normalize().multiplyScalar(currentR2);
    playerFacing.copy(moveDir);
  }

  // Apply gravity (radially inward)
  playerYVel -= 30 * dt;
  playerYVel = Math.max(playerYVel, -25);

  const currentR = playerMesh.position.length();
  const groundR = PLANET_RADIUS + 2.6;

  // Apply vertical velocity
  const newR = currentR + playerYVel * dt;
  if (newR <= groundR) {
    // Hit ground
    playerMesh.position.normalize().multiplyScalar(groundR);
    playerYVel = 0;
    isOnGround = true;
    canJump = true;
  } else {
    playerMesh.position.normalize().multiplyScalar(newR);
    isOnGround = newR < groundR + 0.15;
  }

  // ‚îÄ‚îÄ Orient player mesh to planet surface + facing direction ‚îÄ‚îÄ
  // We build a rotation matrix from: up = planetUp, forward = playerFacing
  const up = playerMesh.position.clone().normalize();
  // Re-project facing onto tangent plane
  let fwd = playerFacing.clone().sub(up.clone().multiplyScalar(playerFacing.dot(up))).normalize();
  if (fwd.length() < 0.01) fwd.set(1, 0, 0).sub(up.clone().multiplyScalar(up.x)).normalize();
  const rgt = new THREE.Vector3().crossVectors(fwd, up).normalize();

  // Build rotation matrix: x=right, y=up, z=forward
  const rotMatrix = new THREE.Matrix4().makeBasis(rgt, up, fwd.clone().negate());
  playerQuat.setFromRotationMatrix(rotMatrix);

  // Smooth rotation
  playerMesh.quaternion.slerp(playerQuat, moving ? 0.25 : 0.1);

  // Walking animation
  if (moving || !isOnGround) {
    animTime += dt * (isRunning ? 12 : 7);
    const legSwing = Math.sin(animTime) * 0.45;
    const armSwing = Math.sin(animTime + Math.PI) * 0.35;
    playerMesh.children.forEach(c => {
      if (c.userData.isLegL) c.rotation.x = legSwing;
      if (c.userData.isLegR) c.rotation.x = -legSwing;
      if (c.userData.isArmL) c.rotation.x = armSwing;
      if (c.userData.isArmR) c.rotation.x = -armSwing;
    });
  } else {
    playerMesh.children.forEach(c => {
      if (c.userData.isLegL || c.userData.isLegR || c.userData.isArmL || c.userData.isArmR) {
        c.rotation.x *= 0.82;
      }
    });
  }

  updateCamera();
  checkNPCProximity();
  updateMinimapCanvas();
}

function tryJump() {
  if (canJump && isOnGround && State.playing && !State.inDialogue) {
    playerYVel = PLAYER_JUMP;
    isOnGround = false;
    canJump = false;
  }
}

// ‚îÄ‚îÄ CAMERA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCamera() {
  if (!playerMesh) return;
  const up = playerMesh.position.clone().normalize();

  // Build a tangent frame on the planet surface at player position
  // Use world Y as reference for "right", then derive everything
  let refUp = new THREE.Vector3(0, 1, 0);
  if (Math.abs(up.dot(refUp)) > 0.99) refUp.set(1, 0, 0);
  const surfRight = new THREE.Vector3().crossVectors(refUp, up).normalize();
  const surfFwd = new THREE.Vector3().crossVectors(up, surfRight).normalize();

  // Camera orbit offset using cameraAngle (horizontal) and cameraPitch (vertical)
  // Orbit: rotate surfFwd by cameraAngle around up, then tilt by pitch
  const cosA = Math.cos(cameraAngle), sinA = Math.sin(cameraAngle);
  const orbitFwd = surfFwd.clone().multiplyScalar(cosA)
    .addScaledVector(surfRight, sinA);
  // Mix up and orbitFwd by pitch
  const sinP = Math.sin(cameraPitch), cosP = Math.cos(cameraPitch);
  const camDir = orbitFwd.clone().multiplyScalar(cosP)
    .addScaledVector(up, sinP);

  const target = playerMesh.position.clone().addScaledVector(up, 2.0);
  camera.position.copy(target).addScaledVector(camDir, cameraDistance);
  camera.lookAt(target);
  camera.up.copy(up);
}

// ‚îÄ‚îÄ NPC INTERACTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeNPCId = null;

function checkNPCProximity() {
  if (!playerMesh) return;
  let nearest = null, nearestDist = INTERACT_DISTANCE;

  State.npcMeshes.forEach(({ mesh, id }) => {
    const dist = playerMesh.position.distanceTo(mesh.position);
    if (dist < nearestDist) {
      nearest = id;
      nearestDist = dist;
    }
    // Float exclamation
    const excl = mesh.children.find(c => c.userData.isExclamation);
    if (excl) {
      const del = State.deliveries.find(d => d.id === id);
      excl.visible = del && !del.completed;
      excl.position.y = 2.7 + Math.sin(Date.now() * 0.003) * 0.15;
    }
  });

  if (nearest && State.deliveries.find(d => d.id === nearest && !d.completed)) {
    activeNPCId = nearest;
    document.getElementById('interact-hint').classList.add('visible');
    document.getElementById('interact-hint').textContent = isMobile() ? 'Tap üìÆ to interact' : 'Press E to interact';
  } else {
    activeNPCId = null;
    document.getElementById('interact-hint').classList.remove('visible');
  }
}

function tryInteract() {
  if (!State.playing) return;
  if (State.inDialogue) {
    advanceDialogue();
    return;
  }
  if (activeNPCId) {
    startDeliveryDialogue(activeNPCId);
  }
}

// ‚îÄ‚îÄ DIALOGUE SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentDialogLines = [];
let currentDialogLineIdx = 0;
let currentDeliveryNPCId = null;
let dialogPhase = 'delivery'; // 'delivery' | 'choice_kid' | 'choice_mom'

function startDeliveryDialogue(npcId) {
  const delivery = State.deliveries.find(d => d.id === npcId);
  if (!delivery || delivery.completed) return;
  currentDeliveryNPCId = npcId;
  currentDialogLines = delivery.dialogs[1]; // receiver dialog
  currentDialogLineIdx = 0;
  dialogPhase = 'delivery';
  State.inDialogue = true;
  showDialogueLine(currentDialogLines[0]);
  document.getElementById('dialogue-box').classList.add('visible');
}

function showDialogueLine(line) {
  document.getElementById('dialogue-avatar').textContent = line.avatar || 'üë§';
  document.getElementById('dialogue-speaker-name').textContent = line.speaker;
  const textEl = document.getElementById('dialogue-text');
  const hindiEl = document.getElementById('dialogue-hindi');
  textEl.textContent = '';
  hindiEl.textContent = line.hindi || '';
  // Typewriter
  let i = 0;
  const txt = line.text;
  clearInterval(textEl._typeTimer);
  textEl._typeTimer = setInterval(() => {
    textEl.textContent += txt[i];
    i++;
    if (i >= txt.length) clearInterval(textEl._typeTimer);
  }, 28);
}

function advanceDialogue() {
  clearInterval(document.getElementById('dialogue-text')._typeTimer);
  // If currently typing, just complete it
  const textEl = document.getElementById('dialogue-text');
  if (textEl.textContent.length < currentDialogLines[currentDialogLineIdx].text.length) {
    textEl.textContent = currentDialogLines[currentDialogLineIdx].text;
    return;
  }

  currentDialogLineIdx++;
  if (currentDialogLineIdx < currentDialogLines.length) {
    showDialogueLine(currentDialogLines[currentDialogLineIdx]);
  } else {
    // End of dialog sequence
    endDialogSequence();
  }
}

function endDialogSequence() {
  const delivery = State.deliveries.find(d => d.id === currentDeliveryNPCId);
  document.getElementById('dialogue-box').classList.remove('visible');
  State.inDialogue = false;

  if (delivery && !delivery.completed) {
    if (delivery.isChoice && dialogPhase === 'delivery') {
      // Show choice for report card
      showChoiceDialogue(delivery);
    } else {
      completeDelivery(currentDeliveryNPCId);
    }
  }
}

function showChoiceDialogue(delivery) {
  // Simple choice toast
  showChoicePrompt(delivery);
}

function showChoicePrompt(delivery) {
  const toast = document.createElement('div');
  toast.className = 'toast info';
  toast.style.cssText = `
    display: flex; flex-direction: column; gap: 8px;
    animation: toastIn 0.4s ease forwards;
    border-left-color: #9C27B0;
  `;
  toast.innerHTML = `
    <div style="font-size:13px;font-weight:700;color:#E1BEE7">Yeh report card kisko dein?</div>
    <div style="display:flex;gap:8px">
      <button id="choice-kid" style="flex:1;padding:8px;background:rgba(156,39,176,0.3);border:1px solid #9C27B0;border-radius:8px;color:white;font-family:'Baloo 2',sans-serif;font-size:13px;font-weight:700;cursor:pointer">üßí Gudiya ko</button>
      <button id="choice-mom" style="flex:1;padding:8px;background:rgba(255,107,43,0.3);border:1px solid #FF6B2B;border-radius:8px;color:white;font-family:'Baloo 2',sans-serif;font-size:13px;font-weight:700;cursor:pointer">üë© Ammi ko</button>
    </div>
  `;
  document.getElementById('toast-container').appendChild(toast);
  document.getElementById('choice-kid').onclick = () => {
    toast.remove();
    currentDialogLines = delivery.choiceDialogs.kid;
    currentDialogLineIdx = 0;
    dialogPhase = 'choice_kid';
    State.inDialogue = true;
    showDialogueLine(currentDialogLines[0]);
    document.getElementById('dialogue-box').classList.add('visible');
  };
  document.getElementById('choice-mom').onclick = () => {
    toast.remove();
    currentDialogLines = delivery.choiceDialogs.mom;
    currentDialogLineIdx = 0;
    dialogPhase = 'choice_mom';
    State.inDialogue = true;
    showDialogueLine(currentDialogLines[0]);
    document.getElementById('dialogue-box').classList.add('visible');
  };
}

function completeDelivery(id) {
  const delivery = State.deliveries.find(d => d.id === id);
  if (!delivery) return;
  delivery.completed = true;
  updateDeliveryHUD();
  showToast('‚úÖ ' + delivery.complete, 'success');
  // Hide NPC exclamation
  const npcData = State.npcMeshes.find(n => n.id === id);
  if (npcData) {
    const excl = npcData.mesh.children.find(c => c.userData.isExclamation);
    if (excl) excl.visible = false;
  }
  // Check completion
  const allDone = State.deliveries.every(d => d.completed);
  if (allDone) {
    setTimeout(showCompletionScreen, 2000);
  }
}

// ‚îÄ‚îÄ DELIVERY HUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildDeliveryHUD() {
  const list = document.getElementById('delivery-list');
  list.innerHTML = '';
  State.deliveries.forEach(d => {
    const item = document.createElement('div');
    item.className = 'delivery-item' + (d.completed ? ' completed' : '');
    item.id = 'delivery-' + d.id;
    item.innerHTML = `
      <div class="delivery-icon">${d.icon}</div>
      <div class="delivery-info">
        <div class="delivery-name">${d.name}</div>
        <div class="delivery-desc">${d.desc}</div>
      </div>
      <div class="delivery-check">${d.completed ? '‚úì' : ''}</div>
    `;
    list.appendChild(item);
  });
}

function updateDeliveryHUD() {
  State.deliveries.forEach(d => {
    const el = document.getElementById('delivery-' + d.id);
    if (!el) return;
    el.className = 'delivery-item' + (d.completed ? ' completed' : '');
    el.querySelector('.delivery-check').textContent = d.completed ? '‚úì' : '';
  });
}

// ‚îÄ‚îÄ EMOTE SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildEmotePicker() {
  const picker = document.getElementById('emote-picker');
  picker.innerHTML = '';
  EMOTES.forEach(({ icon, label }) => {
    const btn = document.createElement('button');
    btn.className = 'emote-btn';
    btn.innerHTML = `${icon}<span class="emote-label">${label}</span>`;
    btn.addEventListener('click', () => {
      triggerEmote(icon);
    });
    picker.appendChild(btn);
  });
}

function triggerEmote(icon) {
  if (!playerMesh) return;
  showEmoteAboveMesh(playerMesh, icon);
  broadcastEmote(icon);
  State.emoteCount++;
}

function showEmoteAboveMesh(mesh, icon) {
  // Project mesh position to screen and show emoji
  const pos3d = mesh.position.clone().add(mesh.position.clone().normalize().multiplyScalar(3.5));
  const vec = pos3d.project(camera);
  const x = (vec.x * 0.5 + 0.5) * window.innerWidth;
  const y = (-vec.y * 0.5 + 0.5) * window.innerHeight;
  const el = document.createElement('div');
  el.className = 'emote-popup';
  el.textContent = icon;
  el.style.left = x + 'px';
  el.style.top = (y - 60) + 'px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2600);
}

// ‚îÄ‚îÄ CUSTOMIZER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildCustomizer() {
  function makeSwatches(containerId, colors, key) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    colors.forEach(c => {
      const sw = document.createElement('div');
      sw.className = 'color-swatch' + (State.playerColor[key] === c ? ' active' : '');
      sw.style.background = c;
      sw.addEventListener('click', () => {
        State.playerColor[key] = c;
        container.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
        sw.classList.add('active');
        rebuildPlayerMesh();
      });
      container.appendChild(sw);
    });
  }
  makeSwatches('kurta-swatches', KURTA_COLORS, 'kurta');
  makeSwatches('pant-swatches', PANT_COLORS, 'pant');
  makeSwatches('skin-swatches', SKIN_TONES, 'skin');

  document.getElementById('custom-toggle').addEventListener('click', () => {
    document.getElementById('custom-drawer').classList.toggle('open');
  });
}

function rebuildPlayerMesh() {
  if (!playerMesh) return;
  const pos = playerMesh.position.clone();
  const rot = playerMesh.rotation.clone();
  scene.remove(playerMesh);
  playerMesh = buildPlayerMesh(State.playerColor.kurta, State.playerColor.pant, State.playerColor.skin);
  playerMesh.position.copy(pos);
  playerMesh.rotation.copy(rot);
  // Re-add nametag
  const tag = makeNameTag(State.playerName);
  playerMesh.add(tag);
  scene.add(playerMesh);
}

// ‚îÄ‚îÄ MINIMAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateMinimapCanvas() {
  const c = document.getElementById('minimap-canvas');
  const ctx = c.getContext('2d');
  const W = c.width, H = c.height;
  ctx.clearRect(0,0,W,H);

  // Background circle
  ctx.beginPath();
  ctx.arc(W/2, H/2, W/2-2, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(13,10,30,0.8)';
  ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  if (!playerMesh) return;

  // Convert spherical position to 2D map coords
  function worldToMap(pos) {
    const n = pos.clone().normalize();
    const lon = Math.atan2(n.z, n.x);
    const lat = Math.asin(n.y);
    const mx = (lon / (Math.PI*2) + 0.5) * W;
    const my = (0.5 - lat / Math.PI) * H;
    return { x: mx, y: my };
  }

  // Draw NPC dots
  State.npcMeshes.forEach(({ mesh, id }) => {
    const del = State.deliveries.find(d => d.id === id);
    const mp = worldToMap(mesh.position);
    ctx.beginPath();
    ctx.arc(mp.x, mp.y, 3.5, 0, Math.PI*2);
    ctx.fillStyle = del && del.completed ? '#4CAF50' : '#FFD700';
    ctx.fill();
  });

  // Draw remote players
  Object.values(remotePlayers).forEach(rp => {
    const mp = worldToMap(rp.mesh.position);
    ctx.beginPath();
    ctx.arc(mp.x, mp.y, 3, 0, Math.PI*2);
    ctx.fillStyle = '#4FC3F7';
    ctx.fill();
  });

  // Draw player (center-ish)
  const pmp = worldToMap(playerMesh.position);
  ctx.beginPath();
  ctx.arc(pmp.x, pmp.y, 4.5, 0, Math.PI*2);
  ctx.fillStyle = '#FF6B2B';
  ctx.fill();
  ctx.beginPath();
  ctx.arc(pmp.x, pmp.y, 4.5, 0, Math.PI*2);
  ctx.strokeStyle = 'white';
  ctx.lineWidth = 1.5;
  ctx.stroke();
}

// ‚îÄ‚îÄ AMBIENT PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let particleSystem = null;
function buildParticles() {
  const count = 120;
  const geo = new THREE.BufferGeometry();
  const pos = new Float32Array(count * 3);
  for (let i = 0; i < count; i++) {
    const r = PLANET_RADIUS + 3 + Math.random() * 8;
    const phi = Math.random() * Math.PI * 2;
    const theta = Math.random() * Math.PI;
    pos[i*3] = r * Math.sin(theta) * Math.cos(phi);
    pos[i*3+1] = r * Math.cos(theta);
    pos[i*3+2] = r * Math.sin(theta) * Math.sin(phi);
  }
  geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
  const mat = new THREE.PointsMaterial({
    color: 0xFFD580, size: 0.18, transparent: true, opacity: 0.5,
    blending: THREE.AdditiveBlending, depthWrite: false
  });
  particleSystem = new THREE.Points(geo, mat);
  scene.add(particleSystem);
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg, type = '') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  container.appendChild(toast);
  setTimeout(() => { if (toast.parentNode) toast.remove(); }, 3800);
}

// ‚îÄ‚îÄ COMPLETION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showCompletionScreen() {
  const elapsed = Math.round((Date.now() - State.startTime) / 60000);
  document.getElementById('stat-deliveries').textContent = '5';
  document.getElementById('stat-time').textContent = elapsed || '< 1';
  document.getElementById('stat-emotes').textContent = State.emoteCount;
  document.getElementById('completion-screen').classList.add('visible');
  // Confetti-like particles burst
  for (let i = 0; i < 20; i++) {
    setTimeout(() => {
      const emotes = ['üéâ','üå∫','üôè','üíå','‚ú®','üéä','üéà','ü•≥'];
      const e = emotes[Math.floor(Math.random()*emotes.length)];
      const el = document.createElement('div');
      el.className = 'emote-popup';
      el.textContent = e;
      el.style.left = (20 + Math.random() * 60) + 'vw';
      el.style.top = (30 + Math.random() * 40) + 'vh';
      el.style.fontSize = (24 + Math.random()*32) + 'px';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2600);
    }, i * 120);
  }
}

document.getElementById('play-again-btn').addEventListener('click', () => {
  location.reload();
});

// ‚îÄ‚îÄ LOADING PROGRESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setLoadingProgress(pct, status) {
  document.getElementById('loading-bar').style.width = pct + '%';
  document.getElementById('loading-status').textContent = status;
}

// ‚îÄ‚îÄ MOBILE DETECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isMobile() {
  return /Android|iPhone|iPad|iPod|Touch/i.test(navigator.userAgent) || window.innerWidth < 768;
}

// ‚îÄ‚îÄ RESIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('resize', () => {
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
});

// ‚îÄ‚îÄ MAIN GAME LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastTime = 0;
let networkTimer = 0;

function gameLoop(time) {
  requestAnimationFrame(gameLoop);
  const dt = Math.min((time - lastTime) / 1000, 0.05);
  lastTime = time;

  if (!State.playing) return;

  // Slow planet rotation
  planetGroup.rotation.y += 0.00015;

  updatePlayer(dt);

  // NPC idle bobbing
  State.npcMeshes.forEach(({ mesh }) => {
    mesh.children.forEach(c => {
      if (c.userData.isArmL) c.rotation.x = Math.sin(time * 0.001 + 0.3) * 0.12;
      if (c.userData.isArmR) c.rotation.x = Math.sin(time * 0.001 + 3.0) * 0.12;
    });
  });

  // Particles drift
  if (particleSystem) {
    particleSystem.rotation.y += 0.0003;
    particleSystem.rotation.x += 0.00008;
  }

  // Network update throttled
  networkTimer += dt;
  if (networkTimer > 0.05) {
    sendPlayerState();
    networkTimer = 0;
  }

  renderer.render(scene, camera);
}

// ‚îÄ‚îÄ GAME START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initGame() {
  setLoadingProgress(10, 'Stitching the uniform...');
  setupLighting();
  setLoadingProgress(25, 'Building the gully...');
  buildStars();
  buildPlanet();
  setLoadingProgress(55, 'Setting up the Dak Ghar...');
  buildPostOffice();
  setLoadingProgress(70, 'Placing the neighbours...');
  createPlayer();
  setLoadingProgress(82, 'Filling the mailbag...');
  buildDeliveryHUD();
  buildEmotePicker();
  buildCustomizer();
  setLoadingProgress(92, 'Adding ambient particles...');
  buildParticles();
  setLoadingProgress(100, 'Ready to deliver!');

  // Add nametag to player
  const tag = makeNameTag(State.playerName);
  playerMesh.add(tag);

  await new Promise(r => setTimeout(r, 600));

  // Hide loading, show start screen
  document.getElementById('loading-screen').classList.add('fade-out');
  setTimeout(() => {
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('start-screen').classList.add('visible');
  }, 800);

  // Mobile controls
  if (isMobile()) {
    document.getElementById('mobile-controls').classList.add('visible');
  }

  // Start render loop (but game logic not active yet)
  requestAnimationFrame(gameLoop);
}

document.getElementById('start-btn').addEventListener('click', startGame);
document.getElementById('player-name-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') startGame();
});

function startGame() {
  const name = document.getElementById('player-name-input').value.trim() || randomName();
  State.playerName = name;
  // Rebuild nametag
  if (playerMesh) {
    playerMesh.children.forEach(c => {
      if (c.isSprite) playerMesh.remove(c);
    });
    const tag = makeNameTag(State.playerName);
    playerMesh.add(tag);
  }
  document.getElementById('start-screen').classList.remove('visible');
  State.playing = true;
  State.startTime = Date.now();

  // Show HUD elements
  document.getElementById('delivery-hud').classList.add('visible');
  document.getElementById('emote-picker').classList.add('visible');
  document.getElementById('customizer-panel').classList.add('visible');
  document.getElementById('player-count').classList.add('visible');
  document.getElementById('minimap').classList.add('visible');

  showToast('üôè Namaste ' + State.playerName + '! Chitthiyaan deliver karo.', 'info');
  setTimeout(() => showToast('üìç Map mein peele dots dhoondo!', ''), 2000);

  // Connect multiplayer
  connectMultiplayer();
}

document.getElementById('dialogue-continue').addEventListener('click', () => {
  if (State.inDialogue) advanceDialogue();
});

// ‚îÄ‚îÄ KICK IT OFF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initGame();
</script>
</body>
</html>
